## 1. Общие принципы

- Все файлы хранятся во внешнем **Yandex Object Storage (S3-совместимом)**.
- **Метаданные** хранятся в PostgreSQL (`file_metadata`).
- Для файлов > 100 МБ используется **multipart upload**.
- **MinIO** — временное внутреннее хранилище, его API не документируется.

---

## 2. Файлы отзывов (с валидацией)

1. Клиент → `POST /files` с телом файла.
2. **API Controller** → передаёт файл в **Компонент проверки файлов**.
3. **Проверка**:
   - Расширение (`.jpg`, `.mp4`),
   - MIME-type,
   - Размер (≤ 5 ГБ),
   - Формат (валидный JPEG, MP4 и т.д.).
4. Если проверка пройдена:
   - Сервис **инициирует multipart upload в Yandex**,
   - Разбивает файл на части (≥ 5 МБ),
   - Загружает каждую часть → сохраняет `(PartNumber, ETag)` в БД,
   - Завершает загрузку → получает финальный `ETag`,
   - Сохраняет `storagePath` и `etag` в `file_metadata`,
   - Публикует задачу в Kafka.
5. Если проверка не пройдена:
   - Возвращает `400 Bad Request`,
   - Удаляет временные данные.

### S3-контракт (загрузка)
| Операция | Метод | Описание |
|----------|-------|---------|
| Инициализация | `POST /{bucket}/{key}?uploads` | Возвращает `UploadId` |
| Загрузка части | `PUT /{bucket}/{key}?partNumber=N&uploadId=id` | Возвращает `ETag` части |
| Завершение | `POST /{bucket}/{key}?uploadId=id` + XML списка частей | Возвращает финальный `ETag` |

>  **Хранение в БД**:  
> - Колонка `s3_upload_id` (TEXT, NULL) — для отслеживания незавершённых загрузок,  
> - Колонка `s3_parts` (JSONB) — массив `{partNumber: 1, etag: "..."}`.

---

## 3. Файлы отчётов (без проверки)

1. «Сервис управления отчётностью» → `POST /files` с телом файла.
2. **API Controller**:
   - Пропускает валидацию,
   - Сразу загружает файл в Yandex (простой PUT или multipart),
   - Сохраняет метаданные со статусом `READY`.

### S3-контракт (загрузка)
- Для файлов < 100 МБ: `PUT /{bucket}/{key}`
- Для файлов ≥ 100 МБ: multipart upload (как в п.2)

>  Нет хранения частей в БД — файл считается готовым сразу.

---

## 4. Обработка Worker'ом

1. **Worker** получает задачу из Kafka.
2. Скачивает файл из Yandex по `storagePath`.
3. Загружает во внутренний MinIO.
4. Запускает антивирус (KESL).
5. Если угроз не обнаружено → отправляет в обработчик медиа.
6. После обработки:
   - Загружает финальную версию в Yandex (новый `storagePath` или перезапись),
   - Удаляет исходный файл из Yandex,
   - Удаляет файл из MinIO,
   - Обновляет статус на `READY`.

### S3-контракт (скачивание)
| Операция | Метод | Описание |
|----------|-------|---------|
| Скачивание | `GET /{bucket}/{key}` | Возвращает тело файла и заголовки (`ETag`, `Content-Length`) |

>  MinIO использует тот же S3 API, но как внутренний компонент — не документируется.

---

## 5. Удаление файлов

- При `DELETE /files/{id}`:
  - Устанавливается `deleted_at = NOW()`,
  - Фоновая задача удаляет файл из Yandex через `DELETE /{bucket}/{key}`.