## 1. Общие принципы

- Все файлы хранятся во внешнем **Yandex Object Storage (S3-совместимом)**.
- **Метаданные файлов** хранятся в PostgreSQL (`file_metadata`).
- Для файлов **≥ 100 МБ** используется **multipart upload** через **бэкенд**.
- **MinIO** — временное внутреннее хранилище для Worker’а, его API не документируется.
- **Фронтенд не имеет прямого доступа к S3** — вся загрузка и скачивание идут через REST API файлового сервиса.

---

## 2. Чанковая загрузка через бэкенд

Клиент использует три эндпоинта:

1. **`POST /files/upload`**  
   → Создаёт сессию multipart-загрузки, возвращает `uploadId` и `partSize` (минимум 5 МБ).

2. **`PUT /files/upload/{uploadId}`**  
   → Загружает часть файла как `application/octet-stream`.  
   → Номер части передаётся в заголовке `Part-Number`.

3. **`POST /files/upload/{uploadId}`**  
   → Завершает загрузку и регистрирует метаданные файла.

> Файловый сервис **сам управляет multipart-сессией в Yandex S3**:  
> - Инициирует `startUpload`,  
> - Загружает каждую часть через `uploadPart`,  
> - Хранит `(PartNumber, ETag)` **во временном хранилище (Redis)**,  
> - При завершении вызывает `completeUpload`.  
>  
> **Данные multipart-сессии НЕ сохраняются в PostgreSQL** — только финальные метаданные файла.

---

## 3. Скачивание файла

- Клиент вызывает **`GET /files/{fileId}/access`**.
- Сервис проверяет права доступа и генерирует **временную ссылку (presigned URL)** на скачивание из Yandex S3.
- Ссылка действительна **15 минут**.
- Клиент скачивает файл **напрямую из S3** по этой ссылке.

---

## 4. Типы файлов и валидация

### Файлы отзывов (проходят валидацию)
1. После завершения загрузки → файл попадает в **Компонент проверки файлов**.
2. Проверяются:
   - Расширение (`.jpg`, `.mp4`),
   - MIME-type (по сигнатуре),
   - Размер (≤ 5 ГБ),
   - Формат (валидный JPEG, MP4).
3. Если проверка пройдена → статус `PENDING`, публикация в Kafka.
4. Если не пройдена → файл удаляется из S3, возвращается `400 Bad Request`.

### Файлы отчётов (без валидации)
- Загружаются тем же способом,
- После завершения сразу получают статус `READY`,
- Валидация не выполняется.

---

## 5. S3-контракт (внутренний, используется файловым сервисом)

| Операция | HTTP-метод | Путь | Описание |
|----------|-----------|------|---------|
| Инициализация | `POST` | `/{bucket}/{key}?uploads` | Возвращает `UploadId` |
| Загрузка части | `PUT` | `/{bucket}/{key}?partNumber=N&uploadId=id` | Возвращает `ETag` части |
| Завершение | `POST` | `/{bucket}/{key}?uploadId=id` | Тело: XML со списком частей |
| Скачивание (Worker) | `GET` | `/{bucket}/{key}` | Возвращает файл и заголовки |
| Удаление | `DELETE` | `/{bucket}/{key}` | Удаляет файл из S3 |

>Эти вызовы **не видны клиенту** — они выполняются **внутренне** файловым сервисом.

---

## 6. Обработка Worker’ом

1. Получает задачу из Kafka.
2. Скачивает файл из Yandex (`GET /{bucket}/{key}`).
3. Сохраняет во внутренний MinIO.
4. Запускает антивирус (KESL).
5. Если угроз нет → отправляет в обработчик медиа.
6. После обработки:
   - Загружает финальную версию обратно в Yandex,
   - Удаляет исходный и временный файлы,
   - Обновляет статус на `READY`.

---

## 7. Удаление файлов

- При `DELETE /files/{id}`:
  - Устанавливается `deleted_at = NOW()` (логическое удаление),
  - Фоновая задача удаляет файл из Yandex через `DELETE /{bucket}/{key}`.