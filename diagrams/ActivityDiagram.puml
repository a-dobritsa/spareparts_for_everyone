@startuml
title Механика работы с корзиной и оформления заказа
skinparam activity {
  startColor green
  stopColor red
}

swimlane Клиент
  start
  :Просмотр каталога,\nпоиск по VIN/артикулу;
  :Добавить товар\nв корзину;
  note 
    POST /carts/items
  end note

swimlane Сервер
  if (Корзина существует?) then (Нет)
    :Создать анонимную корзину;
    :Сгенерировать уникальный cartId\n(UUID v4);
  endif
  :Вернуть cartId\nв Location и теле ответа;

swimlane Клиент
  :Сохранить cartId\n(в cookie/localStorage);

swimlane Сервер
  :Проверить наличие\nтовара на складе;
  if (Достаточно\nтовара?) then (Нет)
    swimlane Клиент
      :Недостаточно\nтовара;
      note
        400 Bad Request
        error "insufficient_stock"
        available 5
      end note
      stop
  endif
  :Добавить товар\nв корзину;

swimlane Клиент
  :Обновить/удалить\nтовары;
  note
    PATCH /carts/{cartId}/items/{itemId}
    DELETE /carts/{cartId}/items/{itemId}
  end note

swimlane Сервер
  :Обновить корзину\nпо cartId\n(без авторизации);

swimlane Клиент
  :Нажать "Оформить\nзаказ";
  note
    POST /carts/{cartId}/checkout
  end note

swimlane Сервер
  if (JWT\nпредоставлен?) then (Нет)
    swimlane Клиент
      :401 Unauthorized;\nперенаправление на логин;
      :Отправить логин/\nпароль;
      note
        POST /auth/login
      end note

    swimlane Сервер
      :Аутентифицировать\nпользователя;
      if (Успешно?) then (Нет)
        swimlane Клиент
          :Неверные\nданные;
          note
            400 Bad Request
            error "invalid_credentials"
          end note
          stop
      endif
      :Привязать корзину\nк user_id\n(UPDATE carts SET user_id = ?);
  endif

  :Проверить наличие\nвсех товаров\nв корзине;
  if (Есть\nнедоступные\nтовары?) then (Да)
    swimlane Клиент
      :Товары\nнедоступны;
      note
        409 Conflict
        error "items_unavailable"
      end note
      stop
  endif

  :Создать заказ\nв БД;
  :Отправить\nуведомление;

swimlane Клиент
  :Успешно;
  note
    201 Created
    {orderId: "12345"}
  end note
  stop
@enduml